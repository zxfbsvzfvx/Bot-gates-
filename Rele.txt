// ========== –ë–ò–ë–õ–ò–û–¢–ï–ö–ò ==========
#include <OneWire.h>
#include <DallasTemperature.h>
#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <UniversalTelegramBot.h>
#include <ArduinoJson.h>

// ========== –ù–ê–°–¢–†–û–ô–ö–ò WiFi –ò TELEGRAM ==========
const char* ssid = "–í–ê–®_WIFI_SSID";
const char* password = "–í–ê–®_WIFI_–ü–ê–†–û–õ–¨";
#define BOT_TOKEN "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê"
#define CHAT_ID "–í–ê–®_CHAT_ID"

// ========== –ü–ò–ù–´ ESP32 ==========
#define TEMP_PIN 4
#define RELAY_OPEN 26
#define RELAY_CLOSE 27
#define RELAY_STOP 14
#define RELAY_ENABLE 12
#define BUZZER 18
#define LED_STATUS 5

// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –û–ë–™–ï–ö–¢–´ ==========
OneWire oneWire(TEMP_PIN);
DallasTemperature sensors(&oneWire);
WiFiClientSecure client;
UniversalTelegramBot bot(BOT_TOKEN, client);

// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
float lastTemp = 0;
unsigned long lastTelegramCheck = 0;
bool systemOverheated = false;
bool tempSensorConnected = true; // –§–ª–∞–≥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–∞—Ç—á–∏–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
unsigned long operationStartTime = 0;
enum GateState { GATE_CLOSED, GATE_OPENING, GATE_OPEN, GATE_CLOSING, GATE_STOPPED };
GateState currentState = GATE_CLOSED;

// ========== –ù–ê–°–¢–†–û–ô–ö–ê ==========
void setup() {
  Serial.begin(115200);
  
  // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∏–Ω–æ–≤
  pinMode(RELAY_OPEN, OUTPUT);
  pinMode(RELAY_CLOSE, OUTPUT);
  pinMode(RELAY_STOP, OUTPUT);
  pinMode(RELAY_ENABLE, OUTPUT);
  pinMode(BUZZER, OUTPUT);
  pinMode(LED_STATUS, OUTPUT);
  
  // –í—ã–∫–ª—é—á–∏—Ç—å –≤—Å–µ —Ä–µ–ª–µ
  digitalWrite(RELAY_OPEN, LOW);
  digitalWrite(RELAY_CLOSE, LOW);
  digitalWrite(RELAY_STOP, HIGH);
  digitalWrite(RELAY_ENABLE, LOW);
  digitalWrite(BUZZER, LOW);
  digitalWrite(LED_STATUS, LOW);
  
  // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç—á–∏–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
  sensors.begin();
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–∞—Ç—á–∏–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
  delay(1000);
  int deviceCount = sensors.getDeviceCount();
  if (deviceCount == 0) {
    Serial.println("‚ö†Ô∏è –î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –ù–ï –Ω–∞–π–¥–µ–Ω!");
    tempSensorConnected = false;
  } else {
    Serial.print("‚úÖ –î–∞—Ç—á–∏–∫–æ–≤ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –Ω–∞–π–¥–µ–Ω–æ: ");
    Serial.println(deviceCount);
    tempSensorConnected = true;
  }
  
  // 3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WiFi
  Serial.print("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WiFi ");
  WiFi.begin(ssid, password);
  
  int wifiTimeout = 30;
  while (WiFi.status() != WL_CONNECTED && wifiTimeout > 0) {
    delay(500);
    Serial.print(".");
    wifiTimeout--;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\n‚úÖ WiFi –ø–æ–¥–∫–ª—é—á–µ–Ω! IP: " + WiFi.localIP().toString());
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    String welcomeMsg = "üö™ –£–º–Ω—ã–µ –≤–æ—Ä–æ—Ç–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã!\n";
    welcomeMsg += "IP: " + WiFi.localIP().toString() + "\n";
    welcomeMsg += "–î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã: " + String(tempSensorConnected ? "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω" : "‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢");
    bot.sendMessage(CHAT_ID, welcomeMsg, "");
  } else {
    Serial.println("\n‚ùå WiFi –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω. –†–∞–±–æ—Ç–∞ –±–µ–∑ Telegram");
  }
  
  Serial.println("–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥...");
  Serial.println("–ö–æ–º–∞–Ω–¥—ã –≤ –º–æ–Ω–∏—Ç–æ—Ä–µ –ø–æ—Ä—Ç–∞: O-–æ—Ç–∫—Ä—ã—Ç—å, C-–∑–∞–∫—Ä—ã—Ç—å, S-—Å—Ç–æ–ø, T-—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞");
}

// ========== –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ ==========
void loop() {
  // 1. –ß—Ç–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (–µ—Å–ª–∏ –¥–∞—Ç—á–∏–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω)
  static unsigned long lastTempRead = 0;
  if (tempSensorConnected && millis() - lastTempRead > 2000) {
    sensors.requestTemperatures();
    float currentTemp = sensors.getTempCByIndex(0);
    lastTempRead = millis();
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫—É –¥–∞—Ç—á–∏–∫–∞
    if (currentTemp == DEVICE_DISCONNECTED_C) {
      Serial.println("‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞—Ç—á–∏–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã!");
      tempSensorConnected = false;
      
      if (WiFi.status() == WL_CONNECTED) {
        bot.sendMessage(CHAT_ID, "‚ö†Ô∏è –û–®–ò–ë–ö–ê: –î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç!", "");
      }
    } else {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–≥—Ä–µ–≤–∞
      if (currentTemp > 70.0) {
        emergencyStop();
        if (WiFi.status() == WL_CONNECTED) {
          String msg = "üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–ï–†–ï–ì–†–ï–í! " + String(currentTemp) + "¬∞C";
          bot.sendMessage(CHAT_ID, msg, "");
        }
        systemOverheated = true;
      }
      
      // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
      if (abs(currentTemp - lastTemp) > 5.0 && WiFi.status() == WL_CONNECTED) {
        String tempMsg = "üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: " + String(currentTemp) + "¬∞C";
        bot.sendMessage(CHAT_ID, tempMsg, "");
        lastTemp = currentTemp;
      }
    }
  }
  
  // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–æ–∫/–¥–∞—Ç—á–∏–∫–æ–≤ (–¥–æ–±–∞–≤—å—Ç–µ –≤–∞—à–∏ —Ñ—É–Ω–∫—Ü–∏–∏)
  checkButtons();
  checkSensors();
  
  // 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –≤–æ—Ä–æ—Ç
  updateGateState();
  
  // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥ –∏–∑ Telegram
  if (WiFi.status() == WL_CONNECTED && millis() - lastTelegramCheck > 1000) {
    int numNewMessages = bot.getUpdates(bot.last_message_received + 1);
    
    while (numNewMessages) {
      for (int i = 0; i < numNewMessages; i++) {
        String chat_id = bot.messages[i].chat_id;
        String text = bot.messages[i].text;
        
        if (chat_id == CHAT_ID) {
          Serial.print("–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –∏–∑ Telegram: ");
          Serial.println(text);
          handleTelegramCommand(text);
        }
      }
      numNewMessages = bot.getUpdates(bot.last_message_received + 1);
    }
    lastTelegramCheck = millis();
  }
  
  // 5. –°–≤–µ—Ç–æ–¥–∏–æ–¥ —Å—Ç–∞—Ç—É—Å–∞
  updateStatusLED();
  
  // 6. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ä–∏–π–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
  handleSerialCommands();
  
  delay(100);
}

// ========== –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î –ò–ó TELEGRAM ==========
void handleTelegramCommand(String command) {
  command.toLowerCase();
  command.trim();
  
  Serial.print("–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã Telegram: ");
  Serial.println(command);
  
  // ========== –ö–û–ú–ê–ù–î–ê "–û–¢–ö–†–´–¢–¨" ==========
  if (command == "/open" || command == "open" || command == "–æ—Ç–∫—Ä—ã—Ç—å") {
    Serial.println("Telegram: –ö–æ–º–∞–Ω–¥–∞ –û–¢–ö–†–´–¢–¨");
    openGate();
  }
  
  // ========== –ö–û–ú–ê–ù–î–ê "–ó–ê–ö–†–´–¢–¨" ==========
  else if (command == "/close" || command == "close" || command == "–∑–∞–∫—Ä—ã—Ç—å") {
    Serial.println("Telegram: –ö–æ–º–∞–Ω–¥–∞ –ó–ê–ö–†–´–¢–¨");
    closeGate();
  }
  
  // ========== –ö–û–ú–ê–ù–î–ê "–û–°–¢–ê–ù–û–í–ò–¢–¨" ==========
  else if (command == "/stop" || command == "stop" || command == "–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" || command == "—Å—Ç–æ–ø") {
    Serial.println("Telegram: –ö–æ–º–∞–Ω–¥–∞ –û–°–¢–ê–ù–û–í–ò–¢–¨");
    stopGate();
  }
  
  // ========== –ö–û–ú–ê–ù–î–ê "–¢–ï–ú–ü–ï–†–ê–¢–£–†–ê" ==========
  else if (command == "/temp" || command == "temp" || command == "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞") {
    Serial.println("Telegram: –ó–∞–ø—Ä–æ—Å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã");
    
    if (!tempSensorConnected) {
      bot.sendMessage(CHAT_ID, "‚ùå –û–®–ò–ë–ö–ê: –î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω!\n"
                               "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n"
                               "1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–æ–¥–æ–≤\n"
                               "2. –†–µ–∑–∏—Å—Ç–æ—Ä 4.7–∫–û–º\n"
                               "3. –ü–∏—Ç–∞–Ω–∏–µ 3.3V", "");
    } else {
      sensors.requestTemperatures();
      float temp = sensors.getTempCByIndex(0);
      
      if (temp == DEVICE_DISCONNECTED_C) {
        bot.sendMessage(CHAT_ID, "‚ö†Ô∏è –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –¥–∞—Ç—á–∏–∫–∞", "");
      } else {
        String tempMsg = "üå°Ô∏è –¢–ï–ú–ü–ï–†–ê–¢–£–†–ê: " + String(temp) + "¬∞C\n";
        
        if (temp > 80.0) {
          tempMsg += "üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –¢–ï–ú–ü–ï–†–ê–¢–£–†–ê!";
        } else if (temp > 60.0) {
          tempMsg += "üü° –í–ù–ò–ú–ê–ù–ò–ï: –í—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞";
        } else if (temp > 40.0) {
          tempMsg += "üü¢ –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞";
        } else {
          tempMsg += "üîµ –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞";
        }
        
        bot.sendMessage(CHAT_ID, tempMsg, "");
      }
    }
  }
  
  // ========== –ö–û–ú–ê–ù–î–ê "–°–¢–ê–¢–£–°" ==========
  else if (command == "/status" || command == "status" || command == "—Å—Ç–∞—Ç—É—Å") {
    Serial.println("Telegram: –ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞");
    
    String status = "üìä –°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´:\n";
    status += "üö™ –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Ä–æ—Ç: " + getStateString() + "\n";
    status += "üî• –ü–µ—Ä–µ–≥—Ä–µ–≤: " + String(systemOverheated ? "–î–ê ‚ö†Ô∏è" : "–ù–ï–¢ ‚úÖ") + "\n";
    
    if (tempSensorConnected) {
      sensors.requestTemperatures();
      float temp = sensors.getTempCByIndex(0);
      if (temp != DEVICE_DISCONNECTED_C) {
        status += "üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: " + String(temp) + "¬∞C\n";
      } else {
        status += "üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: –û–®–ò–ë–ö–ê –î–ê–¢–ß–ò–ö–ê ‚ùå\n";
      }
    } else {
      status += "üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: –î–ê–¢–ß–ò–ö –ù–ï –ü–û–î–ö–õ–Æ–ß–ï–ù ‚ùå\n";
    }
    
    status += "üì∂ WiFi: " + String(WiFi.RSSI()) + " dBm\n";
    status += "‚è±Ô∏è –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: " + String(millis() / 60000) + " –º–∏–Ω";
    
    bot.sendMessage(CHAT_ID, status, "");
  }
  
  // ========== –ö–û–ú–ê–ù–î–ê "–°–¢–ê–†–¢/–ü–û–ú–û–©–¨" ==========
  else if (command == "/start" || command == "start" || command == "/help" || command == "help" || command == "–ø–æ–º–æ—â—å") {
    String help = "üö™ –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–û–†–û–¢–ê–ú–ò\n\n";
    help += "üìã –î–û–°–¢–£–ü–ù–´–ï –ö–û–ú–ê–ù–î–´:\n\n";
    help += "üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:\n";
    help += "‚Ä¢ –æ—Ç–∫—Ä—ã—Ç—å - –û—Ç–∫—Ä—ã—Ç—å –≤–æ—Ä–æ—Ç–∞\n";
    help += "‚Ä¢ –∑–∞–∫—Ä—ã—Ç—å - –ó–∞–∫—Ä—ã—Ç—å –≤–æ—Ä–æ—Ç–∞\n";
    help += "‚Ä¢ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Ä–æ—Ç–∞\n\n";
    help += "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n";
    help += "‚Ä¢ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ - –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É\n";
    help += "‚Ä¢ —Å—Ç–∞—Ç—É—Å - –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã\n\n";
    help += "‚öôÔ∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ:\n";
    help += "‚Ä¢ —Ç–µ—Å—Ç - –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã\n";
    help += "‚Ä¢ —Å–±—Ä–æ—Å - –°–±—Ä–æ—Å –ø–µ—Ä–µ–≥—Ä–µ–≤–∞";
    
    bot.sendMessage(CHAT_ID, help, "");
  }
  
  // ========== –ö–û–ú–ê–ù–î–ê "–¢–ï–°–¢" ==========
  else if (command == "/test" || command == "test" || command == "—Ç–µ—Å—Ç") {
    bot.sendMessage(CHAT_ID, "üß™ –¢–ï–°–¢ –°–ò–°–¢–ï–ú–´...", "");
    
    // –¢–µ—Å—Ç —Ä–µ–ª–µ
    bot.sendMessage(CHAT_ID, "1. –¢–µ—Å—Ç —Ä–µ–ª–µ...", "");
    digitalWrite(RELAY_OPEN, HIGH);
    delay(300);
    digitalWrite(RELAY_OPEN, LOW);
    delay(300);
    digitalWrite(RELAY_CLOSE, HIGH);
    delay(300);
    digitalWrite(RELAY_CLOSE, LOW);
    
    // –¢–µ—Å—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
    if (tempSensorConnected) {
      sensors.requestTemperatures();
      float temp = sensors.getTempCByIndex(0);
      bot.sendMessage(CHAT_ID, "2. –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: " + String(temp) + "¬∞C ‚úÖ", "");
    } else {
      bot.sendMessage(CHAT_ID, "2. –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: –î–ê–¢–ß–ò–ö –û–¢–°–£–¢–°–¢–í–£–ï–¢ ‚ùå", "");
    }
    
    // –¢–µ—Å—Ç WiFi
    bot.sendMessage(CHAT_ID, "3. WiFi —Å–∏–≥–Ω–∞–ª: " + String(WiFi.RSSI()) + " dBm", "");
    
    // –¢–µ—Å—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
    bot.sendMessage(CHAT_ID, "4. –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã: " + getStateString(), "");
    
    bot.sendMessage(CHAT_ID, "‚úÖ –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù", "");
  }
  
  // ========== –ö–û–ú–ê–ù–î–ê "–°–ë–†–û–°" ==========
  else if (command == "/reset" || command == "reset" || command == "—Å–±—Ä–æ—Å") {
    systemOverheated = false;
    bot.sendMessage(CHAT_ID, "üîÑ –°–±—Ä–æ—Å —Å–∏—Å—Ç–µ–º—ã –ø–µ—Ä–µ–≥—Ä–µ–≤–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω", "");
    Serial.println("–°–±—Ä–æ—Å —Å–∏—Å—Ç–µ–º—ã –ø–µ—Ä–µ–≥—Ä–µ–≤–∞");
  }
  
  // ========== –ù–ï–ò–ó–í–ï–°–¢–ù–ê–Ø –ö–û–ú–ê–ù–î–ê ==========
  else {
    bot.sendMessage(CHAT_ID, "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞\n"
                             "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: –æ—Ç–∫—Ä—ã—Ç—å, –∑–∞–∫—Ä—ã—Ç—å, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, —Å—Ç–∞—Ç—É—Å", "");
  }
}

// ========== –í–ê–®–ò –§–£–ù–ö–¶–ò–ò (–¥–æ–±–∞–≤—å—Ç–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é) ==========
void checkSensors() {
  // –í–ê–® –ö–û–î –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ü–µ–≤–∏–∫–æ–≤
  // –ü—Ä–∏–º–µ—Ä:
  // if (digitalRead(SENSOR_OPEN_PIN) == LOW) { ... }
}

void checkButtons() {
  // –í–ê–® –ö–û–î –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–Ω–æ–ø–æ–∫
  // –ü—Ä–∏–º–µ—Ä:
  // if (digitalRead(BUTTON_OPEN_PIN) == LOW) { openGate(); }
}

void updateGateState() {
  // –í–ê–® –ö–û–î –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–æ—Ä–æ—Ç
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ —Ç.–¥.
}

void updateStatusLED() {
  // –í–ê–® –ö–û–î —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–≤–µ—Ç–æ–¥–∏–æ–¥–æ–º
  static unsigned long lastBlink = 0;
  static bool ledState = false;
  
  switch(currentState) {
    case GATE_CLOSED:
      digitalWrite(LED_STATUS, LOW);
      break;
    case GATE_OPEN:
      digitalWrite(LED_STATUS, HIGH);
      break;
    case GATE_OPENING:
    case GATE_CLOSING:
      if (millis() - lastBlink > 500) {
        ledState = !ledState;
        digitalWrite(LED_STATUS, ledState);
        lastBlink = millis();
      }
      break;
    default:
      digitalWrite(LED_STATUS, LOW);
  }
}

// ========== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –í–û–†–û–¢–ê–ú–ò ==========
void emergencyStop() {
  digitalWrite(RELAY_OPEN, LOW);
  digitalWrite(RELAY_CLOSE, LOW);
  digitalWrite(RELAY_STOP, HIGH);
  digitalWrite(RELAY_ENABLE, LOW);
  currentState = GATE_STOPPED;
  
  if (WiFi.status() == WL_CONNECTED) {
    bot.sendMessage(CHAT_ID, "üõë –ê–í–ê–†–ò–ô–ù–ê–Ø –û–°–¢–ê–ù–û–í–ö–ê!", "");
  }
}

void openGate() {
  if (systemOverheated) {
    String msg = "‚ùå –û–¢–ö–†–´–¢–ò–ï –ù–ï–í–û–ó–ú–û–ñ–ù–û: –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≥—Ä–µ—Ç–∞!";
    Serial.println(msg);
    if (WiFi.status() == WL_CONNECTED) {
      bot.sendMessage(CHAT_ID, msg, "");
    }
    return;
  }
  
  Serial.println("–û—Ç–∫—Ä—ã—Ç–∏–µ –≤–æ—Ä–æ—Ç...");
  digitalWrite(RELAY_ENABLE, HIGH);
  delay(100);
  digitalWrite(RELAY_STOP, LOW);
  delay(50);
  digitalWrite(RELAY_OPEN, HIGH);
  currentState = GATE_OPENING;
  operationStartTime = millis();
  
  if (WiFi.status() == WL_CONNECTED) {
    bot.sendMessage(CHAT_ID, "‚úÖ –í–û–†–û–¢–ê –û–¢–ö–†–´–í–ê–Æ–¢–°–Ø...", "");
  }
}

void closeGate() {
  if (systemOverheated) {
    String msg = "‚ùå –ó–ê–ö–†–´–¢–ò–ï –ù–ï–í–û–ó–ú–û–ñ–ù–û: –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≥—Ä–µ—Ç–∞!";
    Serial.println(msg);
    if (WiFi.status() == WL_CONNECTED) {
      bot.sendMessage(CHAT_ID, msg, "");
    }
    return;
  }
  
  Serial.println("–ó–∞–∫—Ä—ã—Ç–∏–µ –≤–æ—Ä–æ—Ç...");
  digitalWrite(RELAY_ENABLE, HIGH);
  delay(100);
  digitalWrite(RELAY_STOP, LOW);
  delay(50);
  digitalWrite(RELAY_CLOSE, HIGH);
  currentState = GATE_CLOSING;
  operationStartTime = millis();
  
  if (WiFi.status() == WL_CONNECTED) {
    bot.sendMessage(CHAT_ID, "‚úÖ –í–û–†–û–¢–ê –ó–ê–ö–†–´–í–ê–Æ–¢–°–Ø...", "");
  }
}

void stopGate() {
  Serial.println("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–æ—Ä–æ—Ç...");
  digitalWrite(RELAY_OPEN, LOW);
  digitalWrite(RELAY_CLOSE, LOW);
  digitalWrite(RELAY_STOP, HIGH);
  delay(200);
  digitalWrite(RELAY_ENABLE, LOW);
  currentState = GATE_STOPPED;
  
  if (WiFi.status() == WL_CONNECTED) {
    bot.sendMessage(CHAT_ID, "‚èπÔ∏è –í–û–†–û–¢–ê –û–°–¢–ê–ù–û–í–õ–ï–ù–´", "");
  }
}

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
String getStateString() {
  switch(currentState) {
    case GATE_CLOSED: return "–ó–ê–ö–†–´–¢–û";
    case GATE_OPEN: return "–û–¢–ö–†–´–¢–û";
    case GATE_OPENING: return "–û–¢–ö–†–´–í–ê–ï–¢–°–Ø";
    case GATE_CLOSING: return "–ó–ê–ö–†–´–í–ê–ï–¢–°–Ø";
    case GATE_STOPPED: return "–û–°–¢–ê–ù–û–í–õ–ï–ù–û";
    default: return "–ù–ï–ò–ó–í–ï–°–¢–ù–û";
  }
}

// ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –í–ê–®–ï–ì–û –ö–û–î–ê ==========
void beep(int count) {
  for (int i = 0; i < count; i++) {
    digitalWrite(BUZZER, HIGH);
    delay(100);
    digitalWrite(BUZZER, LOW);
    if (i < count - 1) delay(100);
  }
}

// ========== –°–ï–†–ò–ô–ù–´–ï –ö–û–ú–ê–ù–î–´ ==========
void handleSerialCommands() {
  if (Serial.available()) {
    char c = Serial.read();
    
    switch(c) {
      case 'O': case 'o': 
        Serial.println("–ö–æ–º–∞–Ω–¥–∞: –û–¢–ö–†–´–¢–¨");
        openGate();
        break;
      case 'C': case 'c': 
        Serial.println("–ö–æ–º–∞–Ω–¥–∞: –ó–ê–ö–†–´–¢–¨");
        closeGate();
        break;
      case 'S': case 's': 
        Serial.println("–ö–æ–º–∞–Ω–¥–∞: –°–¢–û–ü");
        stopGate();
        break;
      case 'T': case 't': 
        if (tempSensorConnected) {
          sensors.requestTemperatures();
          float temp = sensors.getTempCByIndex(0);
          Serial.print("üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ");
          Serial.print(temp);
          Serial.println("¬∞C");
        } else {
          Serial.println("‚ùå –î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω!");
        }
        break;
      case '?':
        Serial.println("üìã –ö–û–ú–ê–ù–î–´:");
        Serial.println("O - –û—Ç–∫—Ä—ã—Ç—å –≤–æ—Ä–æ—Ç–∞");
        Serial.println("C - –ó–∞–∫—Ä—ã—Ç—å –≤–æ—Ä–æ—Ç–∞");
        Serial.println("S - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å");
        Serial.println("T - –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞");
        Serial.println("? - –°–ø—Ä–∞–≤–∫–∞");
        break;
      case 'R': case 'r': 
        tempSensorConnected = true;
        sensors.begin();
        delay(1000);
        int count = sensors.getDeviceCount();
        Serial.print("–ü–æ–∏—Å–∫ –¥–∞—Ç—á–∏–∫–æ–≤... –ù–∞–π–¥–µ–Ω–æ: ");
        Serial.println(count);
        if (count == 0) tempSensorConnected = false;
        break;
    }
  }
}